var ved="#view_event_details",ced="#com_event_dialog",ccd="#create_calendar_dialog",mcd="#modify_calendar_dialog",dcd="#delete_calendar_dialog";
$(document).ready(function(){apply_jQueryUI_styles();set_default_datepicker_options();set_default_colorpicker_options();$("#calendar_view").fullCalendar({selectable:!0,editable:!0,firstDay:1,timeFormat:"HH:mm",columnFormat:{month:"ddd",week:"ddd d",day:"dddd d MMMM"},titleFormat:{month:"MMMM yyyy",week:"d [ MMM][ yyyy]{ '&#8212;'d MMM yyyy}",day:"dddd, dd MMM, yyyy"},weekMode:"variable",height:calendar_height(),header:{left:"month,agendaWeek,agendaDay",center:"title",right:"today prev,next"},monthNames:["enero",
"febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],monthNamesShort:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],dayNames:["domingo","lunes","martes","mi\u00e9rcoles","jueves","viernes","s\u00e1bado"],dayNamesShort:["dom","lun","mar","mi\u00e9","jue","vie","s\u00e1b"],buttonText:{prev:"&nbsp;&#9668;&nbsp;",next:"&nbsp;&#9658;&nbsp;",prevYear:"&nbsp;&lt;&lt;&nbsp;",nextYear:"&nbsp;&gt;&gt;&nbsp;",today:"Hoy",month:"mes",
week:"semana",day:"d\u00eda"},theme:!0,allDayText:"d\u00eda completo",axisFormat:"HH:mm",slotMinutes:30,firstHour:8,allDayDefault:!1,loading:function(a){a?$("#calendar_view").mask("Sincronizando eventos...",500):$("#calendar_view").unmask()},eventClick:function(a){$(ved).remove();$("body").append('<div id="view_event_details"></div>');$(ved).html($("#view_event_details_template").html());$(ved).data(a);$(ved+" h1.title_value").html(a.title);$(ved+" span.calendar_value").html(get_calendar_displayname(a.calendar));
a.location!==void 0?$(ved+" span.location_value").html(a.location):$(ved+" div.location").hide();$(ved+" span.start_value").html(a.formatted_start+" -");$(ved+" span.end_value").html(a.formatted_end+"");a.formatted_description!==void 0?$(ved+" p.description_value").html(a.formatted_description):$(ved+" div.description").hide();a.rrule!==void 0?a.rrule_explained!==void 0?($(ved+" div.unparseable_rrule").hide(),$(ved+" span.rrule_explained_value").html(a.rrule_explained)):($(ved+" div.parseable_rrule").hide(),
$(ved+" span.rrule_raw_value").html(a.rrule)):($(ved+" div.unparseable_rrule").hide(),$(ved+" div.parseable_rrule").hide());$(ved).overlay({mask:"#444",top:calc_overlay_distance(ved),closeOnClick:!1,load:!0})},select:function(a,b,c,e,d){c=d.name=="month"?!1:c;a={start:a.getTime()/1E3,end:b.getTime()/1E3,allday:c,view:d.name,current_calendar:$("#calendar_list li.selected_calendar").data().calendar};$("#calendar_view").fullCalendar("unselect");event_field_form("new",a)},eventResize:function(a,b,c,e,
d,h,f){b=generate_on_the_fly_form(base_app_url+"caldav2json/resize_or_drag_event",{uid:a.uid,calendar:a.calendar,etag:a.etag,view:f.name,dayDelta:b,minuteDelta:c,allday:a.allDay,was_allday:a.was_allday,type:"resize"});if($("div#comm").data("formcreation")=="ok"){var g=$("#"+b);proceed_send_ajax_form(g,function(b){update_single_event(a,b)},function(a){show_error("Los cambios fallaron",a);e()},function(){e()})}$(g).remove()},eventDrop:function(a,b,c,e,d,h,f,g){b=generate_on_the_fly_form(base_app_url+
"caldav2json/resize_or_drag_event",{uid:a.uid,calendar:a.calendar,etag:a.etag,view:g.name,dayDelta:b,minuteDelta:c,allday:a.allDay,was_allday:a.orig_allday,type:"drag"});if($("div#comm").data("formcreation")=="ok"){var i=$("#"+b);proceed_send_ajax_form(i,function(b){update_single_event(a,b)},function(a){show_error("Los cambios fallaron",a);d()},function(){d()})}$(i).remove()}});$(window).resize(function(){$("#calendar_view").fullCalendar("option","height",calendar_height())});$(".fc-header-right").append('<span class="fc-header-space"></span><span class="fc-button-refresh">Refrescar</span>');
$(".fc-button-refresh").button();$("span.fc-button-refresh").click(function(){$("#calendar_view").fullCalendar("refetchEvents")});$(".fc-button-today").after('<span class="fc-header-space"></span><span class="fc-button-datepicker"><img src="'+base_url+'/img/datepicker.gif" alt="Choose date" /></span><input type="hidden" id="datepicker_fullcalendar" />');$("#datepicker_fullcalendar").datepicker({changeYear:!0,closeText:"Cancelar",onSelect:function(){var a=$("#datepicker_fullcalendar").datepicker("getDate");
$("#calendar_view").fullCalendar("gotoDate",a)}});$(".fc-button-datepicker").click(function(){$("#datepicker_fullcalendar").datepicker("setDate",$("#calendar_view").fullCalendar("getDate"));$("#datepicker_fullcalendar").datepicker("show")});$(ved+" a.link_delete_event").live("click",function(){$(ved).data();$(ved).data();load_generated_dialog("dialog_generator/delete_event",{},function(){$("#delete_event_dialog span.calendar").html(get_calendar_displayname($(ved).data().calendar));$("#delete_event_dialog p.title").html($(ved).data().title);
$(ved).data().rrule===void 0&&$("#delete_event_dialog div.rrule").hide();var a=$("#delete_form");a.find("input.uid").val($(ved).data().uid);a.find("input.calendar").val($(ved).data().calendar);a.find("input.href").val($(ved).data().href);a.find("input.etag").val($(ved).data().etag)},"Borrar evento",[{text:"S\u00ed","class":"addicon btn-icon-event-delete",click:function(){var a=$("#delete_form");proceed_send_ajax_form(a,function(){show_success("Evento eliminado","El evento fue eliminado correctamente");
$("#calendar_view").fullCalendar("removeEvents",$(ved).data().id)},function(a){show_error("No se pudo eliminar el evento",a)},function(){});destroy_dialog("#delete_event_dialog")}},{text:"Cancelar","class":"addicon btn-icon-cancel",click:function(){destroy_dialog("#delete_event_dialog")}}],"delete_event_dialog");$(ved).overlay().close();return!1});$("#calendar_view").fullCalendar("renderEvent",{title:"Little portal",start:"1985-02-15T00:00:00Z",end:"1985-02-15T23:59:59Z",allDay:!0,editable:!1,color:"#E78AEF"},
!0);$(ved+" a.link_edit_event").live("click",function(){var a=$(ved).data(),a={uid:a.uid,calendar:a.calendar,href:a.href,etag:a.etag,start:a.start.getTime()/1E3,end:a.end.getTime()/1E3,summary:a.title,location:a.location,allday:a.allDay,description:a.description,rrule:a.rrule,rrule_serialized:a.rrule_serialized,rrule_explained:a.rrule_explained,recurrence_id:a.recurrence_id,orig_start:a.orig_start,orig_end:a.orig_end};event_field_form("modify",a);$(ved).overlay().close();return!1});$("li.available_calendar").live("click",
function(){$("#calendar_list li.selected_calendar").removeClass("selected_calendar");$(this).attr("id");$(this).addClass("selected_calendar")});$("li.available_calendar").live("dblclick",function(a){a.preventDefault();calendar_modify_form(this)});update_calendar_list(!0);$("img#calendar_list_refresh").click(function(){update_calendar_list(!0)});$("img#calendar_add").click(calendar_create_form)});function calendar_height(){return $(window).height()-100}
function calc_overlay_distance(a){return($(window).height()-$(a).height())/2}function show_error(a,b){$("#popup").freeow(a,b,{classes:["popup_error"],autoHide:!1,showStyle:{opacity:1,left:0},hideStyle:{opacity:0,left:"400px"}})}function show_success(a,b){$("#popup").freeow(a,b,{classes:["popup_success"],autoHide:!0,autoHideDelay:2E3,showStyle:{opacity:1,left:0},hideStyle:{opacity:0,left:"400px"}})}
function load_generated_dialog(a,b,c,e,d,h){b=generate_on_the_fly_form(base_app_url+"caldav2json/edit_event",b);if($("div#comm").data("formcreation")=="ok"){b=$("#"+b);$(b).attr("action");var f=$(b).serialize();$.ajax({url:base_app_url+a,beforeSend:function(){$("body").mask("Cargando di\u00e1logo...",500)},complete:function(){$("body").unmask()},cache:!1,type:"POST",data:f,dataType:"html",error:function(a,b){show_error("Error cargando formulario","Por favor, int\u00e9ntelo de nuevo. Mensaje: "+b)},
success:function(a){$("body").append(a);c();apply_jQueryUI_styles();$("#"+h).dialog({autoOpen:!0,buttons:d,title:e,width:"auto",modal:!0,open:function(a){a=$(a.target).parent().find(".ui-dialog-buttonset").children();add_button_icons(a)},close:function(){$(this).remove()}})}});$(b).remove()}else show_error("Error de interfaz","No se pudo generar di\u00e1logo OTF")}
function proceed_send_ajax_form(a,b,c,e){var d=$(a).attr("action"),a=$(a).serialize();$.ajax({url:d,beforeSend:function(){$("body").mask("Enviando formulario...",1E3)},complete:function(){$("body").unmask()},cache:!1,type:"POST",data:a,dataType:"json",error:function(a,b){show_error("Error procesando formulario","Por favor, int\u00e9ntelo de nuevo. Mensaje: [AS] "+b);$("div#comm").data("lastoperation","failed");e()},success:function(a){var d=a.result,a=a.message;d=="ERROR"?($("div#comm").data("lastoperation",
"failed"),show_error("Ocurri\u00f3 algo inesperado",a),e()):d=="EXCEPTION"?($("div#comm").data("lastoperation","failed"),c(a)):d=="SUCCESS"?($("div#comm").data("lastoperation","success"),b(a)):show_error("Respuesta desconocida del servicio AJAX","Estado "+d+" desconocido.")}})}
function generate_on_the_fly_form(a,b){for(var c="",e=0;e<10;e++)c+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(Math.random()*62));$.ajax({url:base_app_url+"dialog_generator/on_the_fly_form/"+c,cache:!1,type:"POST",contentType:"text",dataType:"text",async:!1,error:function(a,b){show_error("Error cargando formulario din\u00e1mico","Por favor, int\u00e9ntelo de nuevo. Mensaje: "+b);$("#comm").data("formcreation","failed")},success:function(e){$("body").append(e);
$("form#"+c).attr("action",a);$.each(b,function(a,b){$("form#"+c).append('<input type="hidden" name="'+a+'" value="'+b+'" />')});$("#comm").data("formcreation","ok")}});return c}function destroy_dialog(a){$(a).dialog("close");$(a).dialog("destroy");$(a).remove()}function apply_jQueryUI_styles(){$('input[type="text"],input[type="password"],textarea').addClass("ui-widget-content ui-corner-all");$('input[disabled="disabled"]').addClass("ui-state-disabled")}
function set_default_datepicker_options(){$.datepicker.regional.es={closeText:"Cerrar",prevText:"&#x3c;Ant",nextText:"Sig&#x3e;",currentText:"Hoy",monthNames:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],monthNamesShort:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],dayNames:["domingo","lunes","martes","mi&eacute;rcoles","jueves","viernes","s&aacute;bado"],dayNamesShort:["dom","lun","mar","mi&eacute;",
"juv","vie","s&aacute;b"],dayNamesMin:["do","lu","ma","mi","ju","vi","s&aacute;"],weekHeader:"Sm",dateFormat:"dd/mm/yy",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""};$.datepicker.setDefaults($.datepicker.regional.es);$.datepicker.setDefaults({constrainInput:!0})}function set_default_colorpicker_options(){$.fn.colorPicker.defaultColors=["36c","D1001A","06862E","EA5E00","673496","980A6C","887800","000","030E9A"]}
function set_end_minDate(){var a=ced+" input.end_date",b=ced+" input.recurrence_until",c=$(ced+" input.start_date").datepicker("getDate");$(ced+" input.allday").is(":checked")&&c.setTime(c.getTime()+864E5);$(a).datepicker("option","minDate",c);$(b).datepicker("option","minDate",c)}
function update_recurrency_options(a){a=="none"?($(ced+" input.recurrence_count").attr("disabled","disabled"),$(ced+" input.recurrence_count").addClass("ui-state-disabled"),$(ced+" input.recurrence_count").val(""),$(ced+" input.recurrence_until").attr("disabled","disabled"),$(ced+" input.recurrence_until").datepicker("disable"),$(ced+" input.recurrence_until").addClass("ui-state-disabled"),$(ced+" input.recurrence_until").val("")):($(ced+" input.recurrence_count").val()==""&&($(ced+" input.recurrence_until").datepicker("enable"),
$(ced+" input.recurrence_until").removeAttr("disabled"),$(ced+" input.recurrence_until").removeClass("ui-state-disabled")),$(ced+" input.recurrence_until").val()==""&&($(ced+" input.recurrence_count").removeAttr("disabled"),$(ced+" input.recurrence_count").removeClass("ui-state-disabled")))}
function event_field_form(a,b){var c="dialog_generator/",e,d;a=="new"?(c+="create_event",e="Crear nuevo evento",d="creado"):(c+="edit_event",e="Editar evento",d="modificado");load_generated_dialog(c,b,function(){apply_jQueryUI_styles();var a={show24Hours:!0,separator:":",step:30};$(ced+" input.start_time").timePicker(a);$(ced+" input.end_time").timePicker(a);$(ced+" input.start_date").datepicker({onSelect:function(){set_end_minDate()}});$(ced+" input.end_date").datepicker();$(ced+" input.recurrence_until").datepicker();
$(ced+" input.end_time").data("untouched",!0);set_end_minDate();update_recurrency_options($(ced+" select.recurrence_type").val());$(ced+" input.allday").change(function(){var a=$(ced+" input.start_date").datepicker("getDate");set_end_minDate();$(this).is(":checked")?($(ced+" input.start_time").attr("disabled","disabled"),$(ced+" input.start_time").addClass("ui-state-disabled"),$(ced+" input.end_time").attr("disabled","disabled"),$(ced+" input.end_time").addClass("ui-state-disabled")):($(ced+" input.end_date").removeAttr("disabled"),
$(ced+" input.end_date").removeClass("ui-state-disabled"),$(ced+" input.end_date").datepicker("setDate",a),$(ced+" input.start_time").removeAttr("disabled"),$(ced+" input.start_time").removeClass("ui-state-disabled"),$(ced+" input.start_time").timepicker("enable"),$(ced+" input.end_time").removeAttr("disabled"),$(ced+" input.end_time").removeClass("ui-state-disabled"),$(ced+" input.end_time").timepicker("enable"))});$(ced+" select.recurrence_type").change(function(){$(this).val();update_recurrency_options($(this).val())});
$(ced+" input.recurrence_until").change(function(){$(this).val()==""?($(ced+" input.recurrence_count").removeAttr("disabled"),$(ced+" input.recurrence_count").removeClass("ui-state-disabled")):($(ced+" input.recurrence_count").attr("disabled","disabled"),$(ced+" input.recurrence_count").addClass("ui-state-disabled"),$(ced+" input.recurrence_count").val(""))});$(ced+" input.recurrence_count").change(function(){$(this).val()==""?($(ced+" input.recurrence_until").datepicker("enable"),$(ced+" input.recurrence_until").removeAttr("disabled"),
$(ced+" input.recurrence_until").removeClass("ui-state-disabled")):($(ced+" input.recurrence_until").attr("disabled","disabled"),$(ced+" input.recurrence_until").datepicker("disable"),$(ced+" input.recurrence_until").addClass("ui-state-disabled"),$(ced+" input.recurrence_until").val(""))});var b=$.timePicker(ced+" input.start_time").getTime(),c=$.timePicker(ced+" input.end_time").getTime()-b.getTime();$(ced+" input.start_time").change(function(){if($(ced+" input.end_time").data("untouched")){var a=
$.timePicker(ced+" input.start_time").getTime(),c=$.timePicker(ced+" input.end_time").getTime()-b.getTime();$.timePicker(ced+" input.end_time").setTime(new Date(a.getTime()+c));b=a}});$(ced+" input.end_time").change(function(){$.timePicker(this).getTime()-$.timePicker(ced+" input.start_time").getTime()!=c&&$(this).data("untouched",!1)})},e,[{text:"Guardar","class":"addicon btn-icon-event-edit",click:function(){var a=$("#com_form");proceed_send_ajax_form(a,function(a){show_success("Evento "+d,"El evento fue "+
d+" correctamente");$.each(a,function(a,b){reload_event_source(b)});destroy_dialog(ced)},function(a){show_error("Datos inv\u00e1lidos",a)},function(){})}},{text:"Cancelar","class":"addicon btn-icon-cancel",click:function(){destroy_dialog(ced)}}],"com_event_dialog")}function update_single_event(a,b){$.each(b,function(b,e){a[b]=e});$("#calendar_view").fullCalendar("updateEvent",a)}
function calendar_create_form(){load_generated_dialog("dialog_generator/create_calendar",{},function(){apply_jQueryUI_styles();$("input.pick_color").colorPicker()},"Nuevo calendario",[{text:"Crear","class":"addicon btn-icon-calendar-add",click:function(){var a=$("#calendar_create_form");proceed_send_ajax_form(a,function(){show_success("Calendario creado","Ya puede acceder a \u00e9l");destroy_dialog(ccd);update_calendar_list(!1)},function(a){show_error("Datos inv\u00e1lidos",a)},function(){})}},{text:"Cancelar",
"class":"addicon btn-icon-cancel",click:function(){destroy_dialog(ccd)}}],"create_calendar_dialog")}
function calendar_modify_form(a){var b=$(a).data();load_generated_dialog("dialog_generator/modify_calendar",{calendar:b.calendar,color:b.color,displayname:b.displayname,url:b.url},function(){apply_jQueryUI_styles();$("input.pick_color").colorPicker()},"Modificar calendario",[{text:"Eliminar calendario","class":"addicon btn-icon-calendar-delete",click:function(){destroy_dialog(mcd);load_generated_dialog("dialog_generator/delete_calendar",{calendar:$(a).data().calendar,displayname:$(a).data().displayname},
function(){},"Eliminar calendario",[{text:"S\u00ed","class":"addicon btn-icon-calendar-delete",click:function(){var b=$("#delete_calendar_form");proceed_send_ajax_form(b,function(){show_success("Calendario eliminado","El calendario fue eliminado correctamente");$(a).data();$("#calendar_view").fullCalendar("removeEventSource",$(a).data().eventsource);$(a).hasClass("selected_calendar")&&$("#calendar_list li.available_calendar:first").click();$(a).remove()},function(a){show_error("No se pudo eliminar el calendario",
a)},function(){});destroy_dialog(dcd)}},{text:"Cancelar","class":"addicon btn-icon-cancel",click:function(){destroy_dialog(dcd)}}],"delete_calendar_dialog")}},{text:"Modificar","class":"addicon btn-icon-calendar-edit",click:function(){var a=$("#modify_calendar_form");proceed_send_ajax_form(a,function(){show_success("Calendario modificado","Cambios aplicados");destroy_dialog(mcd);update_calendar_list(!1)},function(a){show_error("Datos inv\u00e1lidos",a)},function(){})}},{text:"Cancelar","class":"addicon btn-icon-cancel",
click:function(){destroy_dialog(mcd)}}],"modify_calendar_dialog")}
function update_calendar_list(a){$.ajax({url:base_app_url+"caldav2json/calendar_list",cache:!1,dataType:"json",async:!1,beforeSend:function(){a&&$("body").mask("Actualizando calendarios...",500)},complete:function(){a&&$("body").unmask()},error:function(a,c){show_error("Error cargando lista de calendarios","Por favor, int\u00e9ntelo de nuevo. Mensaje: "+c)},success:function(a){$("#calendar_list li.available_calendar").each(function(){var a=$(this).data();$("#calendar_view").fullCalendar("removeEventSource",
a.eventsource);$(this).remove()});$.each(a,function(a,b){var d=generate_calendar_entry(b);$("#calendar_list ul").append(d);$("#calendar_view").fullCalendar("addEventSource",$(d).data().eventsource)});$("#calendar_list li.available_calendar:first").click()}})}
function generate_event_source(a){return{url:base_app_url+"caldav2json/events/"+a,cache:!1,data:{tzoffset:(new Date).getTimezoneOffset()},error:function(){show_error("Error cargando calendario","Los eventos del calendario "+a+" no se pudieron  cargar. Por favor, int\u00e9ntelo de nuevo")}}}function jq(a){return a.replace(/(:|\.)/g,"\\$1")}
function session_refresh(a){$.ajax({url:base_app_url+"js_generator/dumb",cache:!1,method:"GET",success:function(){},error:function(){show_error("Error refrescando sesi\u00f3n","No se pudo recargar su sesi\u00f3n")}});setTimeout("session_refresh("+a+")",a)}
function add_button_icons(a){a.filter("button.addicon").removeClass("addicon").removeClass("ui-button-text-only").addClass("ui-button-text-icon-primary").each(function(a,c){var e=$(c).attr("class").split(" ");$.each(e,function(a,b){if(b.match(/^btn-icon-/))return $(c).prepend('<span class="ui-button-icon-primary ui-icon '+b+'"></span>'),$(c).removeClass(b),!1})})}
function generate_calendar_entry(a){a.color=a.color===void 0||a.color===!1?"#36c":a.color.substring(0,7);var b=$("<li></li>").addClass("calendar_color").addClass("available_calendar").attr("id","calendar_"+a.calendar).css("background-color",a.color).html(a.shown_displayname),c=generate_event_source(a.calendar);c.color=a.color;a.eventsource=c;b.data(a);b.disableSelection();return b}
function get_calendar_displayname(a){a=$(jq("#calendar_"+a));return calname=a.length==1?$(a).data().displayname:event.calendar+" (?)"}function reload_event_source(a){var b=$(jq("#calendar_"+a));b.length==1?(a=$(b).data().eventsource,$("#calendar_view").fullCalendar("removeEventSource",a),$("#calendar_view").fullCalendar("addEventSource",a)):show_error("Calendario inexistente","Se intent\u00f3 recargar el calendario "+a)};
